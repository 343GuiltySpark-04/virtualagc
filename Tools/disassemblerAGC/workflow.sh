#!/bin/bash

if [[ "$1" == "--help" ]]
then
	echo "This script forms match patterns for a BASELINE AGC software"
	echo "version, and then checks those patterns against the BASELINE."
	echo "The BASELINE.patterns file can be subsequently used for matching"
	echo "a (non-BASELINE) ROPE.bin, but this script doesn't handle that."
	echo ""
	echo "Usage:"
	echo "	         workflow.sh BASELINE [OPTIONS]"
	echo ""
	echo "Both specifyAGC.py and disassemblerAGC.py must be in the PATH."
	echo "By default, Block II (non-BLK2 variant) is assumed.  If the BLK2"
	echo "AGC software is processed then the --blk2 switch must be added,"
	echo "while if Block I software is processed then the --block1 switch"
	echo "is added instead.  Either of these must be the *first* OPTION"
	echo "listed.  If the --min option for specifyAGC.py is used, then it"
	echo "must be the *next* option encountered.  All remaining OPTIONS"
	echo "following these are those sometimes used to supplement "
	echo "disassemblerAGC.py's --find options, such as --hint, --skip,"
	echo "--avoid, and --ignore."
	exit 0
fi

baseline=$1
shift

block1=""
if [[ "$1" == "--block1" ]]
then
	block1="$1"
	shift
fi
blk2=""
if [[ "$1" == "--blk2" ]]
then
	blk2="$1"
	shift
fi
min=""
if [[ "$1" == "--min="* ]]
then
	min="$1"
	shift
fi

specifyAGC.py <$baseline.lst >$baseline-autogenerated.specs $block1 $blk2 $min
disassemblerAGC.py --specs=$baseline-autogenerated.specs <$baseline.binsource >$baseline-autogenerated.patterns $block1 $blk2
disassemblerAGC.py --find=$baseline-autogenerated.patterns --check=$baseline.lst <$baseline.binsource >$baseline-autogenerated.matches $block1 $blk2 $@