# Declared to be in the Public Domain by its author, Ronald S. Burkey.
# 
# Filename:	Makefile
# Purpose:	Builds "modern" HAL/S compiler front-end.
# Requires:	BNF Converter (https://bnfc.digitalgrammars.com/)
# Mods:		2022-12-11 RSB	Adapted from the Makefile autogenerated by
#				BNF Converter from the HAL_S.cf grammar.

APP = modernHAL-S-FC

CC = gcc
CCFLAGS = -O3 -W -Wall

OBJS = temp/Absyn.o temp/Lexer.o temp/Parser.o

.PHONY : clean distclean

all : DemoHAL_S ${APP}

clean :
	rm -f ${APP} ${APP}.o
	if [ -d temp ] ; then rm temp/* -rf; fi
	-make -C temp clean

distclean : clean
	-make -C temp distclean

${APP}.o : modernHAL-S-FC.c
	${CC} ${CCFLAGS} -c -o $@ $^
	
${APP} : ${OBJS} ${APP}.o Printer.o
	${CC} ${CCFLAGS} $^ -o $@

Printer.o : Printer.c Printer.h Absyn.h
	${CC} ${CCFLAGS} -c -o $@ $<

Printer.c Printer.h Absyn.h : temp/Printer.c temp/Printer.h temp/Absyn.h fixPrinter.c
	cp temp/Printer.h .
	cp temp/Absyn.h .
	sed -e '1h;2,$$H;$$!d;g' -re \
		's/void\s+bufAppendC\s*\([^)]*\)\s*\{/void bufAppendC(const char c)\n{\n\#include "fixPrinter.c"\n/' \
		temp/Printer.c >Printer.c

# Run BNF Converter to create the lexer, parser, etc., 
# as well as the demo front-end.
DemoHAL_S ${OBJS} temp/Printer.c : HAL_S.cf
	if [ ! -d temp] ; then mkdir temp ; fi
	cd temp && bnfc --c -l -m ../$^
	make -C temp
	mv temp/TestHAL_S DemoHAL_S
	